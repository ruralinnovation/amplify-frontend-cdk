<!doctype html>
<html lang="en">
  <head>
      <meta charset="UTF-8" />
      <meta name="theme-color" content="#07353F" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="manifest" href="/manifest.json" />
      <link rel="shortcut icon" href="/favicon.ico" />

    <title>Frontend App | CORI/RISI</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet" />

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css" />

    <link href="src/preflight.css"  rel="stylesheet" type="text/css" />
    <link href="src/styles.css"  rel="stylesheet" type="text/css" />

    <script>
      window.global = window;
      window.process = {
        env: { DEBUG: undefined },
      };
      const exports = {};
    </script>

  </head>
  <body>
    <div id="app"></div>

    <tableau-viz
            src="https://10ax.online.tableau.com/t/realcurrents/views/RINcommunitytechinvestment/RINcommunityVCfundedtech?:origin=card_share_link&:embed=n4?:origin=card_share_link"
            device="phone"
            width="550px"
            height="1000px"
            hide-tabs
            toolbar="bottom"
    >
    </tableau-viz>
  </body>
  <script type="module">
    import { renderToDom } from "./src/main.tsx";
    renderToDom(document.getElementById('app'));
  </script>
  <script type="module">
    // import { default as sign } from "jwt-encode";
    // import * as uuid from "uuid";

    import * as tableau from "@tableau/embedding-api";
    import { SheetType, TableauEventType } from "@tableau/embedding-api";
    import CryptoJS from "crypto-js";
    
    // Replace the example values below (remove the brackets).
    // Store secrets securely based on your team's best practices.
    // See: https://help.tableau.com/current/online/en-us/connected_apps_direct.htm

    const clientId = import.meta.env.VITE_TABLEAU_CLIENT_ID;
    const secretId = import.meta.env.VITE_TABLEAU_SECRET_ID;
    const secret = import.meta.env.VITE_TABLEAU_SECRET_VALUE;
    const userId = import.meta.env.VITE_TABLEAU_USER;
    const tokenExpiryInMinutes = 10; // Max of 10 minutes.

    // Remove 'tableau:views:embed_authoring' scope if Authoring is not needed.
    // Remove 'tableau:insights:embed' scope if Pulse is not needed.
    const scopes = [
      // "tableau:insights:embed",
      // "tableau:views:embed_authoring",
      "tableau:views:embed"
    ];

    // const userAttributes = {
    //     //  User attributes are optional.
    //     //  Add entries to this dictionary if desired.
    //     //  "[User Attribute Name]": "[User Attribute Value]",
    // };

    // // First tried this function... could not authenticate with resulting JWT...
    // function generateJwt() {
    //
    //   const header = {
    //     alg: "HS256",
    //     typ: "JWT",
    //     kid: secretId,
    //     iss: clientId
    //   };
    //
    //   const data = {
    //     jti: uuid.v4(),
    //     iss: clientId,
    //     aud: "tableau",
    //     sub: userId,
    //     scp: scopes,
    //     iat: Math.floor(Date.now() / 1000),
    //     exp: Math.floor(Date.now() / 1000) + tokenExpiryInMinutes * 60,
    //     // ...userAttributes
    //   };
    //
    //   const token = sign(data, secret, { header });
    //   console.log(token);
    //
    //   return token;
    // }

    function base64url(source) {
      let encodedSource = CryptoJS.enc.Base64.stringify(source);
      encodedSource = encodedSource.replace(/=+$/, '');
      encodedSource = encodedSource.replace(/\+/g, '-');
      encodedSource = encodedSource.replace(/\//g, '_');
      return encodedSource;
    }

    function createToken (userid,kid,secret,iss,scp){
      const header = {
        "alg": "HS256",
        "typ": "JWT",
        "iss": iss,
        "kid": kid,
      };
      const stringifiedHeader = CryptoJS.enc.Utf8.parse(JSON.stringify(header));
      const encodedHeader = base64url(stringifiedHeader);
      const claimSet = {
        "sub": userid,
        "aud": "tableau",
        "nbf": Math.round(new Date().getTime() / 1000) - 100,
        "jti": new Date().getTime().toString(),
        "iss": iss,
        "scp": scp,
        "exp": Math.round(new Date().getTime() / 1000) + tokenExpiryInMinutes * 60
      };
      const stringifiedData = CryptoJS.enc.Utf8.parse(JSON.stringify(claimSet));
      const encodedData = base64url(stringifiedData);
      const token = encodedHeader + "." + encodedData;
      const stringifiedSignature = CryptoJS.HmacSHA256(token, secret);
      const signature = base64url(stringifiedSignature);
      const signedToken = token + "." + signature;

      console.log(signedToken);

      return signedToken;
    }

    // Get the viz object from the HTML web component
    const viz = document.querySelector('tableau-viz, tableau-authoring-viz');

    // window.token is the JWT generated using a Connected App configured with Direct Trust.
    // The value is generated and is only available when this code executes within the Embedding Playground.
    // See the Connected Apps documentation (https://sfdc.co/ca-direct) for more information.
    // See this repository (https://sfdc.co/ca-jwt) for samples in constious languages.
    // viz.token = window.token;
    // viz.token = generateJwt();
    viz.token = createToken(userId, secretId, secret, clientId, scopes);

    // Wait for the viz to become interactive
    new Promise((resolve, reject) => {
        // Add an event listener to verify the viz becomes interactive
        viz.addEventListener(TableauEventType.FirstInteractive, () => {
            console.log('Viz is interactive!');
            resolve();
        });

        viz.addEventListener(TableauEventType.VizLoadError, (error) => {
            const message = JSON.parse(error.detail.message);
            const errorMessage = JSON.parse(message.errorMessage);

            const displayMessage = `ca-error-${errorMessage.result.errors[0].code}`;
            reject(displayMessage);
        });
    }).then((res) => {
      let dashboard;
      let worksheet;
      if (viz.workbook.activeSheet.sheetType === SheetType.Dashboard) {
        dashboard = viz.workbook.activeSheet;

        // Provide the name of the worksheet you want to use from the dashboard
        worksheet = dashboard.worksheets.find((ws) => ws.name === 'Replace-Name-of-Worksheet');
      } else {
        // Active sheet is already a worksheet
        worksheet = viz.workbook.activeSheet;
      }
    });
  </script>
</html>
